<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMTiles Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 1;
        }
        .legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }
        .legend-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #333;
        }
        .zoom-level {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            font-size: 16px;
            font-weight: bold;
            z-index: 1;
        }
        .layer-control {
            position: absolute;
            top: 70px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 1;
        }
        .layer-control h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: bold;
        }
        .layer-control label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
        }
        .layer-control input[type="radio"] {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="zoom-level" id="zoom-level">ズーム: 12</div>
    <div class="layer-control">
        <h4>ベースレイヤー</h4>
        <label>
            <input type="radio" name="baselayer" value="osm" checked>
            OpenStreetMap
        </label>
        <label>
            <input type="radio" name="baselayer" value="gsi-std">
            地理院地図
        </label>
        <label>
            <input type="radio" name="baselayer" value="gsi-photo">
            地理院航空写真
        </label>
    </div>
    <div class="legend">
        <h4>座標系</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ff6b6b;"></div>
            <span>任意座標系</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #4dabf7;"></div>
            <span>公共座標11系</span>
        </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>

    <script>
        // PMTilesプロトコルの登録
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        // 地図の初期化
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '© OpenStreetMap contributors'
                    },
                    'gsi-std': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">地理院タイル</a>'
                    },
                    'gsi-photo': {
                        type: 'raster',
                        tiles: ['https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg'],
                        tileSize: 256,
                        attribution: '<a href="https://maps.gsi.go.jp/development/ichiran.html" target="_blank">地理院タイル</a>'
                    },
                    'pmtiles': {
                        type: 'vector',
                        url: 'pmtiles://output.pmtiles',
                        attribution: 'PMTiles data'
                    },
                    'chou': {
                        type: 'geojson',
                        data: 'chou.geojson',
                        generateId: true
                    }
                },
                layers: [
                    {
                        id: 'osm',
                        type: 'raster',
                        source: 'osm',
                        minzoom: 0,
                        maxzoom: 22
                    },
                    {
                        id: 'gsi-std',
                        type: 'raster',
                        source: 'gsi-std',
                        minzoom: 0,
                        maxzoom: 22,
                        layout: {
                            visibility: 'none'
                        }
                    },
                    {
                        id: 'gsi-photo',
                        type: 'raster',
                        source: 'gsi-photo',
                        minzoom: 0,
                        maxzoom: 22,
                        layout: {
                            visibility: 'none'
                        }
                    },
                    {
                        id: 'pmtiles-fill',
                        type: 'fill',
                        source: 'pmtiles',
                        'source-layer': 'EPSG6668',
                        minzoom: 15,
                        paint: {
                            'fill-color': [
                                'match',
                                ['get', '座標系'],
                                '任意座標系', '#ff6b6b',  // 赤系
                                '公共座標11系', '#4dabf7', // 青系
                                '#95a5a6' // デフォルト（灰色）
                            ],
                            'fill-opacity': 0.5
                        }
                    },
                    {
                        id: 'pmtiles-fill-hover',
                        type: 'fill',
                        source: 'pmtiles',
                        'source-layer': 'EPSG6668',
                        minzoom: 15,
                        filter: ['==', 'ID', ''],
                        paint: {
                            'fill-color': '#ffff00',
                            'fill-opacity': 0.8
                        }
                    },
                    {
                        id: 'pmtiles-line',
                        type: 'line',
                        source: 'pmtiles',
                        'source-layer': 'EPSG6668',
                        minzoom: 15,
                        paint: {
                            'line-color': [
                                'match',
                                ['get', '座標系'],
                                '任意座標系', '#c92a2a',  // 濃い赤
                                '公共座標11系', '#1971c2', // 濃い青
                                '#495057' // デフォルト（濃い灰色）
                            ],
                            'line-width': 2
                        }
                    },
                    {
                        id: 'chou-fill',
                        type: 'fill',
                        source: 'chou',
                        minzoom: 12,
                        paint: {
                            'fill-color': [
                                'case',
                                ['boolean', ['feature-state', 'hover'], false],
                                '#ffff00',  // ホバー時は黄色
                                [
                                    'case',
                                    ['has', 'KEY_CODE'],
                                    [
                                        'to-color',
                                        [
                                            'concat',
                                            '#',
                                            [
                                                'slice',
                                                [
                                                    'to-string',
                                                    [
                                                        '%',
                                                        [
                                                            '*',
                                                            [
                                                                'to-number',
                                                                ['get', 'KEY_CODE']
                                                            ],
                                                            2654435761
                                                        ],
                                                        16777215
                                                    ]
                                                ],
                                                -6
                                            ]
                                        ]
                                    ],
                                    '#cccccc'
                                ]
                            ],
                            'fill-opacity': [
                                'case',
                                ['boolean', ['feature-state', 'hover'], false],
                                0.8,  // ホバー時は不透明度を上げる
                                0.5
                            ]
                        }
                    },
                    {
                        id: 'chou-line',
                        type: 'line',
                        source: 'chou',
                        minzoom: 12,
                        paint: {
                            'line-color': '#333333',
                            'line-width': 1.5
                        }
                    },
                    {
                        id: 'chou-label',
                        type: 'symbol',
                        source: 'chou',
                        minzoom: 13,
                        layout: {
                            'text-field': ['get', 'S_NAME'],
                            'text-font': ['Noto Sans Regular'],
                            'text-size': 14,
                            'text-anchor': 'center',
                            'text-allow-overlap': false,
                            'text-ignore-placement': false
                        },
                        paint: {
                            'text-color': '#000000',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2
                        }
                    },
                    {
                        id: 'banchi-label',
                        type: 'symbol',
                        source: 'pmtiles',
                        'source-layer': 'EPSG6668',
                        minzoom: 18,
                        layout: {
                            'text-field': ['get', '地番'],
                            'text-font': ['Noto Sans Regular'],
                            'text-size': 12,
                            'text-anchor': 'center',
                            'text-allow-overlap': false,
                            'text-ignore-placement': false
                        },
                        paint: {
                            'text-color': '#1a1a1a',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 1.5
                        }
                    }
                ]
            },
            center: [140.723877, 41.763117],
            zoom: 12,
            minZoom: 10,
            maxZoom: 19
        });

        // ナビゲーションコントロールを追加
        map.addControl(new maplibregl.NavigationControl());

        // ズームレベル表示を更新する関数
        function updateZoomLevel() {
            const zoom = map.getZoom().toFixed(1);
            document.getElementById('zoom-level').textContent = `ズーム: ${zoom}`;
        }

        // 初期表示
        map.on('load', () => {
            updateZoomLevel();
        });

        // ズーム変更時に更新
        map.on('zoom', updateZoomLevel);

        // ベースレイヤー切り替え機能
        const baselayerRadios = document.querySelectorAll('input[name="baselayer"]');
        baselayerRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const selectedLayer = e.target.value;
                
                // すべてのベースレイヤーを非表示
                map.setLayoutProperty('osm', 'visibility', 'none');
                map.setLayoutProperty('gsi-std', 'visibility', 'none');
                map.setLayoutProperty('gsi-photo', 'visibility', 'none');
                
                // 選択されたレイヤーのみ表示
                map.setLayoutProperty(selectedLayer, 'visibility', 'visible');
            });
        });

        // ホバー状態を管理する変数
        let hoveredFeatureId = null;
        let hoveredChouId = null;

        // ポップアップを作成
        const popup = new maplibregl.Popup({
            closeButton: true,
            closeOnClick: false
        });

        map.on('load', () => {
            console.log('Map loaded');
            
            // PMTilesのレイヤーを確認
            map.on('sourcedata', (e) => {
                if (e.sourceId === 'pmtiles' && e.isSourceLoaded) {
                    console.log('PMTiles source loaded');
                    
                    // データの範囲に合わせてズーム
                    const bounds = map.getBounds();
                    console.log('Current bounds:', bounds);
                }
            });

            // 地物をクリックしたときの処理
            map.on('click', 'pmtiles-fill', (e) => {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    const props = feature.properties;
                    
                    // プロパティ情報をHTMLに整形
                    let html = '<div style="max-height: 300px; overflow-y: auto;">';
                    html += '<h3 style="margin-top: 0;">地物情報</h3>';
                    html += '<table style="width: 100%; border-collapse: collapse;">';
                    
                    // 主要な情報を先に表示
                    const mainKeys = ['市区町村名', '大字名', '丁目名', '地番', '地図名'];
                    mainKeys.forEach(key => {
                        if (props[key]) {
                            html += `<tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 4px; font-weight: bold;">${key}</td>
                                <td style="padding: 4px;">${props[key]}</td>
                            </tr>`;
                        }
                    });
                    
                    // その他の情報
                    for (const [key, value] of Object.entries(props)) {
                        if (!mainKeys.includes(key) && value) {
                            html += `<tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 4px; font-weight: bold;">${key}</td>
                                <td style="padding: 4px;">${value}</td>
                            </tr>`;
                        }
                    }
                    
                    html += '</table></div>';
                    
                    // ポップアップを表示
                    popup
                        .setLngLat(e.lngLat)
                        .setHTML(html)
                        .addTo(map);
                }
            });

            // マウスカーソルを変更
            map.on('mouseenter', 'pmtiles-fill', () => {
                const zoom = map.getZoom();
                // ズームレベルが15以上の場合のみカーソルを変更
                if (zoom >= 15) {
                    map.getCanvas().style.cursor = 'pointer';
                }
            });

            map.on('mouseleave', 'pmtiles-fill', () => {
                map.getCanvas().style.cursor = '';
            });

            // PMTilesレイヤーのホバーイベント
            let hoveredProperties = null;
            
            map.on('mousemove', 'pmtiles-fill', (e) => {
                const zoom = map.getZoom();
                
                // ズームレベルが15以上の場合のみホバー処理
                if (zoom >= 15 && e.features.length > 0) {
                    const feature = e.features[0];
                    const props = feature.properties;
                    
                    // 複数のプロパティを組み合わせて一意に識別
                    const uniqueKey = `${props.ID}_${props['市区町村C']}_${props['大字コード']}_${props['丁目コード']}_${props['地番']}`;
                    
                    // 前回と異なるフィーチャーの場合のみ更新
                    if (!hoveredProperties || hoveredProperties.uniqueKey !== uniqueKey) {
                        hoveredProperties = {
                            uniqueKey: uniqueKey,
                            ID: props.ID,
                            市区町村C: props['市区町村C'],
                            大字コード: props['大字コード'],
                            丁目コード: props['丁目コード'],
                            地番: props['地番']
                        };
                        
                        // 複合条件でフィルターを設定
                        map.setFilter('pmtiles-fill-hover', [
                            'all',
                            ['==', 'ID', props.ID],
                            ['==', '市区町村C', props['市区町村C']],
                            ['==', '大字コード', props['大字コード']],
                            ['==', '丁目コード', props['丁目コード']],
                            ['==', '地番', props['地番']]
                        ]);
                    }
                } else if (zoom < 15) {
                    // ズームレベルが15未満になったらホバーレイヤーを非表示
                    map.setFilter('pmtiles-fill-hover', ['==', 'ID', '']);
                    hoveredProperties = null;
                }
            });

            map.on('mouseleave', 'pmtiles-fill', () => {
                // ホバーレイヤーを非表示
                map.setFilter('pmtiles-fill-hover', ['==', 'ID', '']);
                hoveredProperties = null;
            });

            // chouレイヤーのホバーイベント
            map.on('mouseenter', 'chou-fill', () => {
                const zoom = map.getZoom();
                // ズームレベルが15未満の場合のみカーソルを変更
                if (zoom < 15) {
                    map.getCanvas().style.cursor = 'pointer';
                }
            });

            map.on('mousemove', 'chou-fill', (e) => {
                const zoom = map.getZoom();
                
                // ズームレベルが15未満の場合のみホバー処理
                if (zoom < 15 && e.features.length > 0) {
                    const featureId = e.features[0].id;
                    
                    // IDが存在する場合のみ処理
                    if (featureId !== undefined) {
                        // 前のホバー状態をリセット
                        if (hoveredChouId !== null) {
                            map.setFeatureState(
                                { source: 'chou', id: hoveredChouId },
                                { hover: false }
                            );
                        }
                        
                        // 新しいフィーチャーにホバー状態を設定
                        hoveredChouId = featureId;
                        map.setFeatureState(
                            { source: 'chou', id: hoveredChouId },
                            { hover: true }
                        );
                    }
                } else if (zoom >= 15 && hoveredChouId !== null) {
                    // ズームレベルが15以上になったら町のホバー状態をクリア
                    map.setFeatureState(
                        { source: 'chou', id: hoveredChouId },
                        { hover: false }
                    );
                    hoveredChouId = null;
                }
            });

            map.on('mouseleave', 'chou-fill', () => {
                if (hoveredChouId !== null) {
                    map.setFeatureState(
                        { source: 'chou', id: hoveredChouId },
                        { hover: false }
                    );
                }
                hoveredChouId = null;
                map.getCanvas().style.cursor = '';
            });
        });

        // エラーハンドリング
        map.on('error', (e) => {
            console.error('Map error:', e);
        });
    </script>
</body>
</html>
